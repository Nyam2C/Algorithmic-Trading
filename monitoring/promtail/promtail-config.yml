# =============================================================================
# Promtail Configuration
# =============================================================================
# 로그 수집 에이전트 설정
# =============================================================================

server:
  http_listen_port: 9080
  grpc_listen_port: 0

# Loki 서버 위치
clients:
  - url: http://loki:3100/loki/api/v1/push

positions:
  filename: /tmp/positions.yaml

# 로그 수집 설정
scrape_configs:
  # ============================================================================
  # Trading Bot 로그 (logs/bot.log)
  # ============================================================================
  - job_name: trading-bot
    static_configs:
      - targets:
          - localhost
        labels:
          job: trading-bot
          app: trading
          env: testnet
          __path__: /var/log/trading/bot.log

    # 로그 파싱 파이프라인
    pipeline_stages:
      # JSON 파싱 (structured logging)
      - json:
          expressions:
            timestamp: timestamp
            level: level
            message: message
            event: event
            symbol: symbol
            signal: signal
            price: price
            quantity: quantity
            side: side
            rsi: rsi
            confidence: confidence
            pnl: pnl
            trade_id: trade_id

      # 타임스탬프 파싱
      - timestamp:
          source: timestamp
          format: RFC3339

      # 레이블 추가
      - labels:
          level:
          event:
          signal:

  # ============================================================================
  # Error 로그 (logs/error.log)
  # ============================================================================
  - job_name: trading-error
    static_configs:
      - targets:
          - localhost
        labels:
          job: trading-error
          app: trading
          env: testnet
          level: error
          __path__: /var/log/trading/error.log

    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            level: level
            message: message
            error_type: error_type
            stack_trace: stack_trace

      - timestamp:
          source: timestamp
          format: RFC3339

      - labels:
          error_type:

  # ============================================================================
  # Trade 로그 (logs/trade.log) - Sprint 2+
  # ============================================================================
  - job_name: trading-trades
    static_configs:
      - targets:
          - localhost
        labels:
          job: trading-trades
          app: trading
          env: testnet
          __path__: /var/log/trading/trade.log

    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            trade_id: trade_id
            symbol: symbol
            side: side
            entry_price: entry_price
            exit_price: exit_price
            quantity: quantity
            pnl: pnl
            pnl_pct: pnl_pct
            duration: duration

      - timestamp:
          source: timestamp
          format: RFC3339

      - labels:
          side:
          symbol:

  # ============================================================================
  # AI Signal 로그 (logs/ai_signal.log) - Sprint 2+
  # ============================================================================
  - job_name: trading-ai-signals
    static_configs:
      - targets:
          - localhost
        labels:
          job: trading-ai-signals
          app: trading
          env: testnet
          __path__: /var/log/trading/ai_signal.log

    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            signal: signal
            confidence: confidence
            rsi: rsi
            ma_7: ma_7
            ma_25: ma_25
            ma_99: ma_99
            atr: atr
            volume_ratio: volume_ratio
            price: price

      - timestamp:
          source: timestamp
          format: RFC3339

      - labels:
          signal:

  # ============================================================================
  # Docker Container 로그
  # ============================================================================
  - job_name: docker-containers
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
        filters:
          - name: label
            values:
              - "com.docker.compose.project=algorithmic-trading"

    relabel_configs:
      - source_labels: ['__meta_docker_container_name']
        regex: '/(.*)'
        target_label: 'container'
      - source_labels: ['__meta_docker_container_log_stream']
        target_label: 'stream'

    pipeline_stages:
      - docker: {}
      - json:
          expressions:
            level: level
            message: message
      - labels:
          level:
